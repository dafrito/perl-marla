#!/bin/bash
PATH=/bin:/usr/bin

die() {
	echo $* >&2
	exit 1
}

SITE=$1
shift

if test "x$SITE" = x; then
	die "No site name specified. Usage: ./bin/make-site [site-name]"
fi

if test -d $SITE; then
	die "Site '$SITE' already exists. Remove the $SITE directory to recreate."
fi

# Create a new structure from the existing skeleton
cp -r skeleton $SITE || die "Failed to create $SITE"

# Copy this site to websites, so it will be included
# in generated makefiles
if ! grep -q -x -F "$SITE" websites; then
	echo $SITE >>websites
fi

# Replace our placeholder variables with the names
# of our new site
PACKAGE=`echo $SITE | sed -e 's/\./-/g'`
find $SITE -type f | xargs sed -i \
	-e "s/@PACKAGE@/$PACKAGE/g" \
	-e "s/@SITE@/$SITE/g"

# Finally, indicate that we're ready to go
echo "$SITE is ready for use"
