build:
.PHONY: build

SITE=@SITE@
PACKAGE=$(shell echo $(SITE) | sed -e 's/\./-/g')

Makefile: ../skeleton/Makefile
	echo "# Autogenerated Makefile at `date`"  >$@
	echo "# DO NOT EDIT THIS FILE!"           >>$@
	echo                                      >>$@
	cat ../skeleton/Makefile                  >>$@
	sed -i -e 's/[@]SITE@/$(SITE)/g' $@

install: install-httpd
.PHONY: install

# Site-specific Apache configuration
httpdconf=$(HTTPDETC)/sites.d/$(PACKAGE).conf

install-httpd: $(httpdconf)
.PHONY: install-httpd

$(httpdconf): $(HTTPDETC)/sites.d httpd.conf
	cp httpd.conf httpd.conf-wip
	# Use [@] to ensure we don't get substitutions
	sed -i                                                \
		-e "s/[@]SERVER_NAME@/$(SERVER_NAME)/g"           \
		-e "s/[@]PACKAGE@/$(PACKAGE)/g"                   \
		-e "s/[@]IP@/$(IP)/g"                             \
		-e "s/[@]PORT@/$(PORT)/g"                         \
		-e "s/[@]LISTEN_DIRECTIVE@/$(LISTEN_DIRECTIVE)/g" \
	httpd.conf-wip;
	mv httpd.conf-wip $@

$(HTTPDETC)/sites.d: $(HTTPDETC)
	mkdir -p $@

uninstall:
	# Add a couple variable checks, just to be safe
	if test x$(PACKAGE) != x; then                 \
		rm -f $(HTTPDETC)/sites.d/$(PACKAGE).conf; \
	fi;
.PHONY: uninstall

clean:
.PHONY: clean
