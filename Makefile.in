# BUILD and BUILDNAME are provided from ./configure
include build/default.config
export BUILD
export BUILDNAME
export IP

# Default rule
all: tar
.PHONY: all

export FULLNAME=$(NAME)-$(shell git describe --always)

export OUTDIR ?= release
export RPMDIR ?= $$HOME/rpmbuild
export SPECFILE ?= rpm.spec.in

export HTTPDMARLA=conf/marla
export HTTPDETC=$(PREFIX)/etc/httpd/$(HTTPDMARLA)

tarfile=$(FULLNAME).tar.gz

tar: $(OUTDIR)/$(tarfile)
.PHONY: tar

Makefile: Makefile.in configure $(BUILD) build/default.config
	./configure $(BUILDNAME)

$(OUTDIR)/$(tarfile): .git/refs/heads/master | $(OUTDIR)
	git archive --format=tar --prefix=$(FULLNAME)/ HEAD | gzip >$@

$(OUTDIR):
	mkdir -p $(OUTDIR)

spec: $(OUTDIR)/$(NAME).spec
.PHONY: spec

$(OUTDIR)/$(NAME).spec: $(SPECFILE) | $(OUTDIR)
	echo -n >$@
	echo "Name:	$(NAME)" >>$@
	echo "%define fullname $(FULLNAME)" >>$@
	echo "%define buildname $(BUILDNAME)" >>$@
	cat $^ >>$@

RPMFLAGS ?= --ba
rpm: $(OUTDIR)/$(tarfile) $(OUTDIR)/$(NAME).spec | $(RPMDIR)
	cp -u $(OUTDIR)/$(tarfile)	$(RPMDIR)/SOURCES
	cp -u $(OUTDIR)/$(NAME).spec	$(RPMDIR)/SPECS
	rpmbuild $(RPMFLAGS) $(RPMDIR)/SPECS/$(NAME).spec
	cd $(OUTDIR); \
	for package in `rpm -q --specfile ./$(NAME).spec`; do \
		arch=`echo $$package | grep -E -o '[^.]+$$'`; \
		filename="$(RPMDIR)/RPMS/$$arch/$$package.rpm"; \
		[ -e `basename $$filename` ] || ln -s $$filename; \
	done
.PHONY: rpm

$(RPMDIR):
	mkdir -p $@
	cd $@ && mkdir -p SOURCES SPECS BUILD RPMS SRPMS

install: uninstall build install-httpd
	if test x$(PORT) = x; then                    \
		PORT=$(LISTEN_BASE);                      \
	else                                          \
		PORT=$(PORT);                             \
	fi;                                           \
	for site in `cat websites`; do                \
		if test x$(LISTEN_BASE) != x; then        \
			SERVER_NAME=$(IP):$$PORT;             \
		else                                      \
			SERVER_NAME=$$site:$$PORT;            \
		fi;                                       \
		$(MAKE) -C $$site                         \
		SERVER_NAME=$$SERVER_NAME                 \
		PACKAGE=`echo $$site | sed -e 's/\./-/g'` \
		PORT=$$PORT                               \
		install;                                  \
		if test x$(LISTEN_BASE) != x; then        \
			let PORT++;                           \
		fi;                                       \
	done
.PHONY: install

$(HTTPDETC): $(PREFIX)
	mkdir -p $@

build: httpd/sites.conf httpd/listen.conf websites
	for site in `cat websites`; do \
		$(MAKE) -C $$site $@; \
	done
.PHONY: build

httpd/sites.conf: websites
	echo "# Autogenerated from websites at `date`"      >$@-wip
	echo "# DO NOT MANUALLY EDIT THIS FILE!"           >>$@-wip
	echo                                               >>$@-wip
	sed -nre 's#^.*$$#Include @HTTPDMARLA@/\0/site.conf#p' $^ >>$@-wip
	mv $@-wip $@
	chmod ugo-w $@

httpd/listen.conf: websites
	echo "# Autogenerated from websites at `date`"  >$@-wip
	echo "# DO NOT MANUALLY EDIT THIS FILE!"       >>$@-wip
	echo                                           >>$@-wip
	if test x$(PORT) != x; then                              \
		echo "Listen $(IP):$(PORT)"                >>$@-wip; \
	else                                                     \
		i=$(LISTEN_BASE);                                    \
		for website in `cat websites`; do                    \
			echo "Listen $(IP):$$i"                >>$@-wip; \
			let i++;                                         \
		done;                                                \
	fi
	mv $@-wip $@
	chmod ugo-w $@

$(PREFIX):
	mkdir -p $(PREFIX)

install-httpd: $(HTTPDETC) httpd/*.conf
	cp httpd/*.conf $(HTTPDETC)
	PORT=$(PORT); \
	if test x$$PORT = x; then \
		PORT="*"; \
	fi; \
	find $(HTTPDETC) -name '*.conf' | xargs sed -i \
		-e "s#@HTTPDMARLA@#$(HTTPDMARLA)#g" \
		-e "s/@IP@/$(IP)/g" \
		-e "s/@PORT@/$$PORT/g"
.PHONY: install-httpd

uninstall:
	rm -rf $(HTTPDETC)
	for site in `cat websites`; do \
		$(MAKE) -C $$site $@; \
	done
.PHONY: uninstall

# We do NOT delete RPMDIR during clean, since we don't own it.
clean:
	[ "$(OUTDIR)" != "/" ] && rm -rf $(OUTDIR)
	for f in httpd/sites.conf httpd/listen.conf; do \
		if test -e $$f; then \
			chmod -f u+w $$f; \
			rm -f $$f; \
		fi; \
	done;
	for site in `cat websites`; do \
		$(MAKE) -C $$site $@; \
	done
.PHONY: clean

# vim: set noet :
