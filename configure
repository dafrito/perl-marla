#!/bin/bash

die() {
    echo $* >&2
    exit 1
}

if [ -e Makefile ]; then
    rm -f Makefile;
fi

if [ -z "$*" ]; then
    echo "No configuration specified. Configurations available:" >&2
    for f in `ls build/*.config`; do
        echo `basename $f .config` >&2
    done;
    exit 1
fi

BUILDNAME="$*"
BUILD="build/$BUILDNAME.config"
if [ ! -e "$BUILD" ]; then
    echo "No build with name: $BUILDNAME" >&2
    exit 1
fi

NAME=marla
source $BUILD
FULLNAME=$NAME-$BUILDNAME

echo "# Autogenerated Makefile at `date`"  >Makefile-wip
echo "# DO NOT EDIT THIS FILE!"           >>Makefile-wip
echo                                      >>Makefile-wip
echo "NAME=$NAME"                         >>Makefile-wip
echo "FULLNAME=$FULLNAME"                 >>Makefile-wip
echo "BUILD=$BUILD"                       >>Makefile-wip
echo "BUILDNAME=$BUILDNAME"               >>Makefile-wip
echo "include $BUILD"                     >>Makefile-wip
echo                                      >>Makefile-wip
cat Makefile.in                           >>Makefile-wip
chmod ugo-w Makefile-wip
mv Makefile-wip Makefile

echo $FULLNAME >.fullname

# vim: set et :
